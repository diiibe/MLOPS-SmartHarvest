<!DOCTYPE html>
<html>

<head>
    <title>SmartHarvest - Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #1a1a1a;
            color: #e0e0e0;
            box-sizing: border-box;
        }

        * {
            box-sizing: border-box;
        }

        #sidebar {
            width: 280px;
            background: #3a000e;
            /* Darker Wine */
            border-right: 1px solid #500015;
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 25px;
            background: #2b000a;
            /* Even Darker Wine */
            color: white;
            border-bottom: 1px solid #500015;
        }

        .header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header p {
            margin: 5px 0 0;
            opacity: 0.7;
            font-size: 12px;
            text-transform: uppercase;
        }

        .content {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            margin-top: 0;
            color: #fff;
            border-bottom: 2px solid #f1c40f;
            /* Gold accent */
            padding-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .stat-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .stat-val {
            font-size: 14px;
            /* Reduced from 16px */
            font-weight: bold;
            color: #fff;
        }

        .stat-label {
            font-size: 12px;
            /* Reduced from 13px */
            color: #aaa;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            margin-top: 10px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-download {
            background: #27ae60;
            color: white;
        }

        .btn-download:hover {
            background: #219150;
        }

        .btn-new {
            background: #444;
            color: #ccc;
            margin-top: auto;
            border-top: 1px solid #555;
            border-radius: 0;
            padding: 20px;
        }

        .btn-new:hover {
            background: #555;
            color: white;
        }

        #map-container {
            flex-grow: 1;
            border: none;
            width: 100%;
            height: 100%;
        }

        .tabs {
            display: flex;
            background: #3a000e;
            /* Darker Wine */
            border-bottom: 1px solid #500015;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #3a000e;
            text-align: center;
            font-weight: 600;
            color: #aaa;
            font-size: 14px;
            transition: all 0.2s;
            border-right: 1px solid #500015;
        }

        .tab:hover {
            background: #500015;
            color: #fff;
        }

        .tab.active {
            color: #fff;
            border-bottom: 3px solid #f1c40f;
            /* Gold */
            background: #2b000a;
        }

        #report-view {
            display: none;
            padding: 40px;
            overflow-y: auto;
            height: 100%;
            background: #1a1a1a;
            max-width: 800px;
            margin: 0 auto;
            color: #ddd;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Markdown Styling */
        #report-view h1 {
            font-size: 24px;
            color: #fff;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        #report-view h2 {
            font-size: 20px;
            color: #3498db;
            margin-top: 30px;
        }

        #report-view table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        #report-view th,
        #report-view td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }

        #report-view th {
            background: #333;
            font-weight: 600;
            color: #fff;
        }

        #report-view tr:nth-child(even) {
            background: #222;
        }

        /* Time Series Lab Styles */
        .ts-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ts-control-group {
            background: rgba(43, 0, 10, 0.3);
            border: 1px solid #500015;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .ts-control-group h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #f1c40f;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ts-inputs-row {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .ts-input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .ts-input-field label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
        }

        .ts-input-field input {
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .ts-input-field input:focus {
            border-color: #f1c40f;
        }

        .years-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .year-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .year-checkbox:hover {
            border-color: #555;
            background: #252525;
        }

        .year-checkbox input {
            accent-color: #f1c40f;
            width: 18px;
            height: 18px;
        }

        .year-checkbox span {
            font-size: 14px;
            font-weight: 600;
        }

        .ts-btn-generate {
            background: linear-gradient(135deg, #f1c40f, #d4ac0d);
            color: #1a1a1a;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(241, 196, 15, 0.2);
        }

        .ts-btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(241, 196, 15, 0.3);
        }

        .ts-btn-generate:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ts-status {
            background: #111;
            padding: 15px;
            border-radius: 6px;
            height: 350px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            color: #ccc;
            border: 1px solid #333;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .ts-summary {
            background: #252525;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .ts-summary h4 {
            color: #3498db;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-item {
            background: #111;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .summary-item .label {
            display: block;
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .summary-item .value {
            display: block;
            font-size: 18px;
            color: #fff;
            font-weight: bold;
        }

        .summary-note {
            font-size: 12px;
            color: #aaa;
            font-style: italic;
            margin: 0;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .success {
            color: #2ecc71;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-weight: bold;
        }

        #ts-progress-container {
            display: none;
            margin-top: 15px;
        }

        .progress-bar {
            height: 6px;
            background: #222;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: #f1c40f;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="header">
            <h2>{{ project_name }}</h2>
            <p>Analysis Complete</p>
        </div>

        <div class="content">
            <div class="card">
                <h3>Data Collection Stats</h3>
                <div class="stat-list">
                    {% for stat in stats %}
                    <div class="stat-item">
                        <div class="stat-label">{{ stat.label }}</div>
                        <div class="stat-val">{{ stat.value }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <h3>Export</h3>
                <a href="/download/{{ project_name }}" class="btn btn-download">Download Spatial Cube</a>
            </div>

            <div class="card">
                <h3>Legend</h3>
                <p style="font-size: 13px; color: #aaa; line-height: 1.5;">
                    <b>NDVI Delta:</b> Vegetation change (T2 - T1).<br>
                    <b>VH Drop:</b> Structural loss (Radar).<br>
                    <b>LST:</b> Land Surface Temperature.
                </p>
            </div>
        </div>

        <a href="/" class="btn btn-new">Start New Project</a>
    </div>

    <div id="main">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('map')">Interactive Map</div>
            <div class="tab" onclick="switchTab('analysis')">Data Analysis</div>
            <div class="tab" onclick="switchTab('timeseries')">Time-Series Lab</div>
            <div class="tab" onclick="switchTab('report')">Data Report</div>
        </div>

        <div id="map-view" style="flex-grow: 1;">
            <iframe src="/map/{{ project_name }}"></iframe>
        </div>

        <div id="analysis-view" style="display: none; padding: 20px; overflow-y: auto; background: #1a1a1a;">
            <div style="max-width: 1200px; margin: 0 auto;">

                <!-- 1. Temporal Trends Section -->
                {% if charts.temporal_trends %}
                <div style="margin-bottom: 40px;">
                    <h3
                        style="color: #3498db; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px;">
                        1. Temporal Evolution</h3>

                    <div
                        style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3498db;">
                        <strong style="color: #fff;">Intuitive Explanation:</strong>
                        <p style="color: #ccc; font-size: 14px; margin: 5px 0 0;">
                            Think of this as the "heartbeat" of your vineyard.
                            The <span style="color: #2ecc71;">Green Zone (T1)</span> is when vines should be growing
                            fast (lines going up).
                            The <span style="color: #e74c3c;">Red Zone (T2)</span> is when grapes ripen. Here, you want
                            stability. If the lines drop suddenly, your vines might be thirsty or sick.
                        </p>
                    </div>

                    <div
                        style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #555;">
                        <strong style="color: #aaa;">Technical Details:</strong>
                        <p style="color: #888; font-size: 13px; margin: 5px 0 0;">
                            Time-series analysis of mean ROI values.
                            <b>NDVI</b> (Normalized Difference Vegetation Index) proxies photosynthetic activity/vigor.
                            <b>VH Backscatter</b> (Sentinel-1 SAR) proxies canopy structure and moisture content.
                            Shaded regions represent the user-defined phenological windows (T1: Vegetative, T2:
                            Ripening).
                        </p>
                    </div>

                    <div class="card" style="background: #222; border: 1px solid #333;">
                        {{ charts.temporal_trends | safe }}
                    </div>
                </div>
                {% endif %}

                <!-- 2. Full Statistical Distributions -->
                {% if charts.histograms %}
                <div style="margin-bottom: 40px;">
                    <h3
                        style="color: #f39c12; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px;">
                        2. Full Statistical Distributions</h3>

                    <div
                        style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f39c12;">
                        <strong style="color: #fff;">Intuitive Explanation:</strong>
                        <p style="color: #ccc; font-size: 14px; margin: 5px 0 0;">
                            These charts show "how much" of your vineyard falls into different categories for every
                            single metric.
                            For example, if the <b>NDVI Delta</b> peak is to the left of 0, most of your vineyard is
                            losing vigor.
                            If <b>Slope</b> is wide, your terrain is uneven.
                        </p>
                    </div>

                    <div class="card" style="background: #222; border: 1px solid #333;">
                        {{ charts.histograms | safe }}
                    </div>
                </div>
                {% endif %}

                <!-- 3. Correlation Matrix -->
                {% if charts.correlation %}
                <div style="margin-bottom: 40px;">
                    <h3
                        style="color: #9b59b6; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px;">
                        3. Feature Correlations</h3>

                    <div
                        style="background: #252525; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #9b59b6;">
                        <strong style="color: #fff;">Intuitive Explanation:</strong>
                        <p style="color: #ccc; font-size: 14px; margin: 5px 0 0;">
                            This grid shows which factors move together.
                            <b>Red (1.0)</b> means they go up together (e.g., usually Rain and Soil Moisture).
                            <b>Blue (-1.0)</b> means they move opposite (e.g., steeper Slope might mean lower Moisture).
                            Use this to find hidden relationships, like "Does higher Elevation lead to lower Temperature
                            (LST)?"
                        </p>
                    </div>

                    <div class="card" style="background: #222; border: 1px solid #333;">
                        {{ charts.correlation | safe }}
                    </div>
                </div>
                {% endif %}

                <div style="display: flex; gap: 20px; margin-top: 20px;">

                    <!-- 4. Anomaly Detection -->
                    {% if charts.scatter %}
                    <div style="flex: 1;">
                        <h3
                            style="color: #e74c3c; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; font-size: 16px;">
                            4. Anomaly Detection</h3>
                        <p
                            style="color: #ccc; font-size: 13px; line-height: 1.5; margin-bottom: 15px; min-height: 60px;">
                            <b>Intuitive:</b> Look for points that stand out from the main cloud.
                            <br><b>Technical:</b> Scatter plot of NDVI Delta vs VH Drop. Top-left quadrant (High Drop,
                            Low Delta) suggests structural loss without chlorosis (e.g., pruning or wind damage).
                        </p>
                        <div class="card" style="background: #222; border: 1px solid #333;">
                            {{ charts.scatter | safe }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 5. Multi-Dimensional -->
                    {% if charts.scatter_3d %}
                    <div style="flex: 1;">
                        <h3
                            style="color: #1abc9c; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; font-size: 16px;">
                            5. 3D Analysis</h3>
                        <p
                            style="color: #ccc; font-size: 13px; line-height: 1.5; margin-bottom: 15px; min-height: 60px;">
                            <b>Intuitive:</b> Rotate this cube to see how Water (TWI) affects Health (NDVI) and
                            Temperature (LST) all at once.
                        </p>
                        <div class="card" style="background: #222; border: 1px solid #333;">
                            {{ charts.scatter_3d | safe }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 6. Hydrology Analysis -->
                    {% if charts.twi_scatter %}
                    <div style="flex: 1;">
                        <h3
                            style="color: #3498db; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; font-size: 16px;">
                            6. Hydrology Analysis</h3>
                        <p
                            style="color: #ccc; font-size: 13px; line-height: 1.5; margin-bottom: 15px; min-height: 60px;">
                            <b>Intuitive:</b> Does water accumulation (TWI) lead to more vigor?
                            <br><b>Technical:</b> Correlation between Topographic Wetness Index and Peak NDVI.
                        </p>
                        <div class="card" style="background: #222; border: 1px solid #333;">
                            {{ charts.twi_scatter | safe }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <div id="report-view" style="display: none; padding: 20px; overflow-y: auto; background: #1a1a1a;">
            {{ report_html | safe }}
        </div> <!-- END report-view -->

        <div id="timeseries-view"
            style="display: none; padding: 40px; overflow-y: auto; background: #1a1a1a; flex-grow: 1;">
            <div class="ts-container">
                <div style="margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #fff; font-size: 24px;">Time-Series Lab v2.0</h2>
                    <p style="color: #aaa; margin: 8px 0 0; font-size: 14px;">Generate deep-time weekly datasets for
                        Machine Learning analysis.</p>
                </div>

                <!-- 1. Seasonal Range Selector -->
                <div class="ts-control-group">
                    <h4>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        1. Seasonal Window (Timeframe Basis)
                    </h4>
                    <div class="ts-inputs-row">
                        <div class="ts-input-field">
                            <label>Start Date (DD/MM)</label>
                            <input type="text" id="ts-start-date" placeholder="01/05" value="01/05">
                        </div>
                        <div style="color: #555; font-size: 20px; margin-top: 15px;">&rarr;</div>
                        <div class="ts-input-field">
                            <label>End Date (DD/MM)</label>
                            <input type="text" id="ts-end-date" placeholder="30/09" value="30/09">
                        </div>
                        <div style="flex: 1.5; padding-left: 20px;">
                            <p style="font-size: 12px; color: #888; margin: 0;">Select the vegetative cycle range. The
                                algorithm will extract data for every week within this window across the selected years.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 2. Year Selector -->
                <div class="ts-control-group">
                    <h4>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        2. Multi-Year Selection
                    </h4>
                    <div class="years-grid" id="years-selector">
                        <label class="year-checkbox"><input type="checkbox" value="2019"> <span>2019</span></label>
                        <label class="year-checkbox"><input type="checkbox" value="2020"> <span>2020</span></label>
                        <label class="year-checkbox"><input type="checkbox" value="2021"> <span>2021</span></label>
                        <label class="year-checkbox"><input type="checkbox" value="2022"> <span>2022</span></label>
                        <label class="year-checkbox"><input type="checkbox" value="2023" checked>
                            <span>2023</span></label>
                        <label class="year-checkbox"><input type="checkbox" value="2024" checked>
                            <span>2024</span></label>
                    </div>
                </div>

                <!-- 3. Final Actions -->
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="btn-generate-ts" class="ts-btn-generate" onclick="generateTSDataset()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="3">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Run Deep-Time Extraction
                    </button>

                    <div id="ts-status-container" style="display: none;">
                        <div class="ts-status" id="ts-log">Waiting to start...</div>
                        <div id="ts-progress-container">
                            <div class="progress-bar">
                                <div id="ts-progress-fill" class="progress-fill"></div>
                            </div>
                            <div id="ts-progress-text" style="font-size: 11px; color: #888; text-align: right;">0%
                                Complete</div>
                        </div>
                    </div>

                    <a id="btn-download-ts" href="#" class="btn btn-download"
                        style="display: none; padding: 18px; font-size: 16px;">
                        Download ML Dataset (CSV)
                    </a>

                    <div id="ts-summary" class="ts-summary"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        function renderCharts() {
            // No high-level chart rendering needed for static view currently
            // (Mappa e Mappa Analisi sono in iframe o autogenerate)
        }

        document.addEventListener('DOMContentLoaded', renderCharts);

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('map-view').style.display = 'none';
            document.getElementById('analysis-view').style.display = 'none';
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('timeseries-view').style.display = 'none';

            const tabs = document.querySelectorAll('.tab');
            if (tabName === 'map') {
                tabs[0].classList.add('active');
                document.getElementById('map-view').style.display = 'block';
            } else if (tabName === 'analysis') {
                tabs[1].classList.add('active');
                document.getElementById('analysis-view').style.display = 'block';
                window.dispatchEvent(new Event('resize'));
            } else if (tabName === 'timeseries') {
                tabs[2].classList.add('active');
                document.getElementById('timeseries-view').style.display = 'block';
            } else {
                tabs[3].classList.add('active');
                document.getElementById('report-view').style.display = 'block';
            }
        }

        async function generateTSDataset() {
            const startDate = document.getElementById('ts-start-date').value;
            const endDate = document.getElementById('ts-end-date').value;
            const selectedYears = Array.from(document.querySelectorAll('#years-selector input:checked')).map(cb => cb.value);

            if (selectedYears.length === 0) {
                alert("Please select at least one year.");
                return;
            }

            const btn = document.getElementById('btn-generate-ts');
            const log = document.getElementById('ts-log');
            const statusContainer = document.getElementById('ts-status-container');
            const progressContainer = document.getElementById('ts-progress-container');
            const progressFill = document.getElementById('ts-progress-fill');
            const progressText = document.getElementById('ts-progress-text');
            const downloadBtn = document.getElementById('btn-download-ts');

            btn.disabled = true;
            statusContainer.style.display = 'block';
            downloadBtn.style.display = 'none';
            log.innerHTML = "<div>Initializing connection to Google Earth Engine...</div>";
            log.scrollTop = log.scrollHeight;

            try {
                const response = await fetch('/generate_ts_dataset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_name: "{{ project_name }}",
                        start_date: startDate,
                        end_date: endDate,
                        years: selectedYears
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                if (data.message) {
                                    const entry = document.createElement('div');
                                    entry.textContent = data.message;
                                    log.appendChild(entry);
                                    log.scrollTop = log.scrollHeight;
                                }
                                if (data.progress) {
                                    progressContainer.style.display = 'block';
                                    progressFill.style.width = data.progress + "%";
                                    progressText.innerText = Math.round(data.progress) + "% Complete";
                                }
                                if (data.success) {
                                    const entry = document.createElement('div');
                                    entry.className = 'log-entry success';
                                    entry.innerHTML = `<strong>[SUCCESS]</strong> ${data.message}`;
                                    log.appendChild(entry);
                                    const downloadBtn = document.getElementById('btn-download-ts');
                                    downloadBtn.style.display = 'block';
                                    downloadBtn.onclick = () => {
                                        window.location.href = `/download_dataset/${data.project_name}/${data.filename}`;
                                    };

                                    // Show Summary Box
                                    const summaryBox = document.getElementById('ts-summary');
                                    summaryBox.style.display = 'block';
                                    summaryBox.innerHTML = `
                                        <h4>Extraction Summary</h4>
                                        <div class="summary-grid">
                                            <div class="summary-item">
                                                <span class="label">Total Records</span>
                                                <span class="value">${data.records || 'N/A'}</span>
                                            </div>
                                            <div class="summary-item">
                                                <span class="label">File Name</span>
                                                <span class="value" style="font-size: 0.8em;">${data.filename}</span>
                                            </div>
                                        </div>
                                        <p class="summary-note">Check the logs above for details on cloud cover and imagery availability per week.</p>
                                    `;
                                    btn.disabled = false;
                                }
                                if (data.error) {
                                    log.innerText += "\n[ERROR] " + data.error;
                                    btn.disabled = false;
                                }
                            } catch (e) {
                                console.error("Error parsing JSON chunk", e);
                            }
                        }
                    }
                }
            } catch (err) {
                log.innerText += "\n[CONNECTION ERROR] " + err.message;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>